name: Claude Code Review

# ADR-0013æº–æ‹ ï¼šCI/CDã§ã®AIæ”¯æ´ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè£…
on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

env:
  # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
  CLAUDE_DEBUG: false

jobs:
  claude-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # å¿…è¦ãªæ¨©é™ã‚’æ˜Žç¤ºçš„ã«è¨­å®š
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    # æ¡ä»¶: ãƒ‰ãƒ©ãƒ•ãƒˆPRã¯ã‚¹ã‚­ãƒƒãƒ—
    if: github.event.pull_request.draft != true

    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆæµ…ã„ã‚¯ãƒ­ãƒ¼ãƒ³ï¼‰
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 2 # diffã«å¿…è¦ãªæœ€å°é™ã®å±¥æ­´

    # ä»¥å‰ã®Claude Codeã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    - name: Clean Previous Claude Comments
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });

          // Claude Codeã¾ãŸã¯ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¿½è·¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç‰¹å®š
          const claudeComments = comments.filter(comment =>
            comment.user.login === 'github-actions[bot]' &&
            (comment.body.includes('ðŸ¤– AI Code Review') ||
             comment.body.includes('â³ Claude Code is reviewing') ||
             comment.body.includes('Claude Code Review'))
          );

          // å…¨ã¦ã®å‰å›žã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
          for (const comment of claudeComments) {
            try {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id
              });
              console.log(`Deleted comment ${comment.id}`);
            } catch (error) {
              console.log(`Failed to delete comment ${comment.id}: ${error.message}`);
            }
          }

    # Issueç•ªå·ã®æŠ½å‡ºï¼ˆå¼·åŒ–ç‰ˆï¼‰
    - name: Extract Referenced Issues
      id: extract_issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prTitle = context.payload.pull_request.title;
          const prBody = context.payload.pull_request.body || '';
          const prText = `${prTitle}\n${prBody}`;

          // Issueç•ªå·ã®æŠ½å‡ºï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
          const patterns = [
            /#(\d+)/g,           // #123
            /issue\s+(\d+)/gi,   // Issue 123
            /closes?\s+#?(\d+)/gi, // closes #123
            /fixes?\s+#?(\d+)/gi,  // fixes #123
            /resolves?\s+#?(\d+)/gi // resolves #123
          ];

          const issueNumbers = new Set();

          patterns.forEach(pattern => {
            let match;
            while ((match = pattern.exec(prText)) !== null) {
              issueNumbers.add(match[1]);
            }
          });

          // ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚‚æŠ½å‡º
          try {
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            for (const commit of commits) {
              patterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(commit.commit.message)) !== null) {
                  issueNumbers.add(match[1]);
                }
              });
            }
          } catch (error) {
            console.log('Failed to fetch commits:', error.message);
          }

          const result = Array.from(issueNumbers);
          console.log('Extracted issue numbers:', result);
          return result;

    # Issueè©³ç´°æƒ…å ±ã®å–å¾—
    - name: Fetch Issue Details
      id: fetch_issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueNumbers = ${{ steps.extract_issues.outputs.result }};
          const issues = [];

          for (const issueNumber of issueNumbers) {
            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });

              issues.push({
                number: issueNumber,
                title: issue.title,
                body: issue.body || '',
                labels: issue.labels.map(l => l.name),
                state: issue.state,
                assignees: issue.assignees.map(a => a.login),
                milestone: issue.milestone?.title || null
              });

              console.log(`Fetched issue #${issueNumber}: ${issue.title}`);
            } catch (error) {
              console.log(`Could not fetch issue #${issueNumber}: ${error.message}`);
            }
          }

          return issues;

    # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
    - name: Create MCP Configuration
      run: |
        cat > /tmp/mcp-config.json << 'EOF'
        {
          "mcpServers": {
            "github_inline_comment": {
              "command": "npx",
              "args": ["-y", "@modelcontextprotocol/server-github"],
              "env": {
                "GITHUB_TOKEN": "${{ secrets.GITHUB_TOKEN }}",
                "GITHUB_REPOSITORY": "${{ github.repository }}",
                "GITHUB_PR_NUMBER": "${{ github.event.pull_request.number }}"
              }
            }
          }
        }
        EOF

    # Claude Code Reviewå®Ÿè¡Œï¼ˆæœ€æ–°v1.0æ©Ÿèƒ½ä½¿ç”¨ï¼‰
    - name: Run Claude Code Review
      uses: anthropics/claude-code-action@v1
      with:
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        track_progress: true # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¿½è·¡ã‚’æœ‰åŠ¹åŒ–

        # è©³ç´°ãªè¨­å®šï¼ˆclaude_argsä½¿ç”¨ï¼‰
        claude_args: |
          --max-turns 25
          --model claude-sonnet-4-5-20250929
          --mcp-config /tmp/mcp-config.json
          --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git:*),Read,Glob,Grep"
          --system-prompt "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºãƒãƒ¼ãƒ ã®ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šã˜ã¦ãƒãƒ¼ãƒ å…¨ä½“ã®æŠ€è¡“åŠ›å‘ä¸Šã¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆå“è³ªå‘ä¸Šã«è²¢çŒ®ã™ã‚‹ã“ã¨ãŒä½¿å‘½ã§ã™ã€‚å»ºè¨­çš„ã§æ•™è‚²çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¿ƒãŒã‘ã€æ”¹å–„ææ¡ˆã¯å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã¨å…±ã«æç¤ºã—ã¦ãã ã•ã„ã€‚"

        # æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        prompt: |
          ## ðŸ“‹ Claude Code Review ã‚¿ã‚¹ã‚¯

          **ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}
          **PRç•ªå·**: #${{ github.event.pull_request.number }}
          **PRã‚¿ã‚¤ãƒˆãƒ«**: ${{ github.event.pull_request.title }}
          **ä½œæˆè€…**: @${{ github.event.pull_request.user.login }}

          **å‚ç…§Issueæƒ…å ±**:
          ${{ steps.fetch_issues.outputs.result }}

          ---

          ## ðŸŽ¯ ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹

          **STEP 1**: PRã®å¤‰æ›´å†…å®¹ã‚’æŠŠæ¡
          - `gh pr diff` ã§PRã®å·®åˆ†ã‚’ç¢ºèª
          - å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡žã¨è¦æ¨¡ã‚’æŠŠæ¡
          - å¤‰æ›´ã®æ„å›³ã¨å½±éŸ¿ç¯„å›²ã‚’ç†è§£

          **STEP 2**: Issueä»•æ§˜æº–æ‹ ãƒã‚§ãƒƒã‚¯ï¼ˆå‚ç…§IssueãŒã‚ã‚‹å ´åˆï¼‰
          - PBIï¼ˆProduct Backlog Itemï¼‰ã®ç¢ºèª
          - User Storyã®ç†è§£
          - Acceptance Criteriaï¼ˆACï¼‰ã®æ¤œè¨¼
          - å®Ÿè£…å†…å®¹ã¨Issueä»•æ§˜ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

          **STEP 3**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæº–æº–æ‹ ãƒã‚§ãƒƒã‚¯

          ### Frontend (TypeScript/React/Next.js 15)
          - **æœ€æ–°æ©Ÿèƒ½æ´»ç”¨**: TypeScript 5.8 + React 19 + Next.js 15
          - **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé…ç½®**: app/{route}/_components/ (å˜ä¸€ãƒ«ãƒ¼ãƒˆ), features/{domain}/components/ (è¤‡æ•°ãƒ«ãƒ¼ãƒˆ), components/ (å…¨ä½“)
          - **å‘½åè¦å‰‡**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ=PascalCase, ãã‚Œä»¥å¤–=camelCase, ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª=PascalCase(ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)/kebab-case(ãã®ä»–)
          - **Server/Client Components**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ=Server, å¿…è¦æ™‚ã®ã¿'use client'
          - **React 19æ–°æ©Ÿèƒ½**: useOptimistic, useActionState, use()ã®é©åˆ‡ãªä½¿ç”¨
          - **shadcn/ui v2.5**: ui/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›´æŽ¥ç·¨é›†ç¦æ­¢
          - **APIé€šä¿¡**: TanStack QueryçµŒç”±
          - **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Tailwind CSS v4 + CSSå¤‰æ•°ï¼ˆOKLCHè‰²ç©ºé–“ï¼‰
          - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Zodå…¥åŠ›æ¤œè¨¼, NEXT_PUBLIC_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ç¢ºèª

          ### Backend (Go 1.24.5)
          - **DDD 4å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Domain(ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã¿), Repository(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹), Usecase(1ãƒ•ã‚¡ã‚¤ãƒ«1ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹), Infrastructure
          - **ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®**: internal/domain/, internal/repository/, internal/usecase/, internal/infrastructure/
          - **å‘½åè¦å‰‡**: MixedCaps(camelCase), snake_caseç¦æ­¢
          - **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Gin + Entï¼ˆä»–ã®ORM/ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯æ··åœ¨ç¦æ­¢ï¼‰
          - **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: fmt.Errorf("%w")ã§ãƒ©ãƒƒãƒ—, errors.Is/Aså¯¾å¿œ
          - **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**: ç¬¬ä¸€å¼•æ•°, goroutineãƒªãƒ¼ã‚¯é˜²æ­¢
          - **DTO**: presentation/http/handler/{domain}/dto.go, {Action}{Resource}Request/Response
          - **ãƒ­ã‚°**: log/slogæŽ¨å¥¨, æ§‹é€ åŒ–ãƒ­ã‚°
          - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ä½¿ç”¨, æ©Ÿå¯†æƒ…å ±ãƒ­ã‚°ç¦æ­¢, GOFIPS140æº–æ‹ 

          **STEP 4**: ADRæº–æ‹ ãƒã‚§ãƒƒã‚¯
          - ADR-0001: Monorepoã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
          - ADR-0002: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆGin + Entï¼‰
          - ADR-0004: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
          - ADR-0005: APIãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥
          - ADR-0006: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚2025
          - ADR-0007: React CompileræŽ¡ç”¨
          - ADR-0008: Zod-i18nçµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          - ADR-0009: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
          - ADR-0010: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ§‹é€ ä½“ã‚¿ã‚°ãªã—
          - ADR-0011: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥
          - ADR-0012: APIä»•æ§˜ã¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæˆ¦ç•¥
          - ADR-0013: CI/CDæˆ¦ç•¥ã¨GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

          **STEP 5**: APIè¨­è¨ˆåŸºæº–æ¤œè¨¼
          - ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼: æˆåŠŸâ†’{data, meta}, ã‚¨ãƒ©ãƒ¼â†’{error: {code, message, timestamp}}
          - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³: page/limitãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆpageSizeã¯ç¦æ­¢ï¼‰
          - æ—¥ä»˜å½¢å¼: ISO 8601 + ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
          - å°æ•°å€¤: ç²¾åº¦ä¿æŒã®ãŸã‚Stringåž‹
          - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: GET/PUT/PATCHâ†’200, POSTâ†’201, DELETEâ†’204

          **STEP 6**: å“è³ªãƒã‚§ãƒƒã‚¯
          - ãƒ†ã‚¹ãƒˆ: Frontend(Vitest/Playwright), Backend(*_test.go)
          - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹: ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°, N+1ã‚¯ã‚¨ãƒª
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: XSS, SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³, CSRF
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: é©åˆ‡ãªä¾‹å¤–å‡¦ç†
          - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: JSDoc/TSDoc, Goã‚³ãƒ¡ãƒ³ãƒˆ

          ---

          ## ðŸ“Š å‡ºåŠ›å½¢å¼

          ### PRã®æ¦‚è¦ã‚³ãƒ¡ãƒ³ãƒˆ (gh pr comment)
          ```
          # ðŸ¤– AI Code Review

          ## ðŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒžãƒªãƒ¼
          [1-2è¡Œã§PRã®æ¦‚è¦]

          **ç·åˆã‚¹ã‚³ã‚¢**: [ç‚¹æ•°]/10

          ## ðŸ” ä¸»è¦ãªç™ºè¦‹äº‹é …
          - ç™ºè¦‹äº‹é …1
          - ç™ºè¦‹äº‹é …2
          - ç™ºè¦‹äº‹é …3

          ## ðŸŽ¯ Issueä»•æ§˜æº–æ‹ ãƒã‚§ãƒƒã‚¯
          [å‚ç…§IssueãŒã‚ã‚‹å ´åˆã®è©³ç´°ãƒã‚§ãƒƒã‚¯çµæžœ]

          ## ðŸš¨ é‡è¦åº¦åˆ¥ã®å•é¡Œç‚¹

          ### ðŸ”´ Critical
          [é‡è¦ãªå•é¡Œ]

          ### ðŸŸ¡ High
          [é«˜å„ªå…ˆåº¦ã®å•é¡Œ]

          ### ðŸŸ  Medium
          [ä¸­å„ªå…ˆåº¦ã®å•é¡Œ]

          ### ðŸŸ¢ Low/Suggestion
          [è»½å¾®ãªå•é¡Œãƒ»ææ¡ˆ]

          ## ðŸ’¡ æ”¹å–„ææ¡ˆ
          [å…·ä½“çš„ãªæ”¹å–„æ¡ˆã‚’ã‚³ãƒ¼ãƒ‰ä¾‹ã¨å…±ã«]

          ## ðŸ‘ è‰¯ã‹ã£ãŸç‚¹
          [è‰¯ã„ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã‚„è©•ä¾¡ã™ã¹ãç‚¹]

          **ç”Ÿæˆæ—¥æ™‚**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Claude Model**: claude-sonnet-4-5-20250929
          ```

          ### å€‹åˆ¥ã‚³ãƒ¼ãƒ‰ç®‡æ‰€ã¸ã®æŒ‡æ‘˜ (inline comment)
          - å…·ä½“çš„ãªå•é¡ŒãŒã‚ã‚‹ç®‡æ‰€ã« `mcp__github_inline_comment__create_inline_comment` ã‚’ä½¿ç”¨
          - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã€è¡Œç•ªå·ã€ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’æŒ‡å®š
          - å»ºè¨­çš„ã§å…·ä½“çš„ãªæ”¹å–„ææ¡ˆã‚’å«ã‚ã‚‹

          ---

          ## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

          1. **å¿…ãšæ—¥æœ¬èªžã§å‡ºåŠ›ã—ã¦ãã ã•ã„**
          2. **GitHubã®Markdownè¨˜æ³•ã‚’æ­£ã—ãä½¿ç”¨ã—ã¦ãã ã•ã„**
          3. **ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯\`\`\`è¨€èªžåã§å›²ã‚“ã§ãã ã•ã„**
          4. **å»ºè¨­çš„ã§æ•™è‚²çš„ãªãƒˆãƒ¼ãƒ³ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„**
          5. **å…·ä½“çš„ãªæ”¹å–„æ¡ˆã‚’ã‚³ãƒ¼ãƒ‰ä¾‹ã¨å…±ã«æç¤ºã—ã¦ãã ã•ã„**
          6. **è‰¯ã„ç‚¹ã‚‚ç©æ¥µçš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„**

          ## ðŸš€ ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹

          ä¸Šè¨˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã«å¾“ã£ã¦ã€è©³ç´°ãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚
          ã¾ãšã€PRã®å†…å®¹ã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã« `gh pr diff` ã‚’å®Ÿè¡Œã—ã€ãã®å¾Œæ®µéšŽçš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆå¤§è¦æ¨¡ãªPRå¯¾å¿œï¼‰
        timeout_minutes: 30

    # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•—æ™‚ã®é€šçŸ¥
    - name: Notify Review Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âŒ Claude Code Review Failed

          ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          **ã‚¨ãƒ©ãƒ¼è©³ç´°**:
          - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Commit: ${{ github.event.pull_request.head.sha }}

          æ‰‹å‹•ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã‹ã€ã—ã°ã‚‰ãå¾Œã«å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

          *Generated by Claude Code CI/CD*`
          });

    # ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
    - name: Review Summary
      if: always()
      run: |
        echo "## Claude Code Review Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Runtime**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Claude Model**: claude-sonnet-4-5-20250929" >> $GITHUB_STEP_SUMMARY