name: Claude Code Review

# This workflow implements AI-assisted code review as defined in ADR-0013
# See: docs/adr/adr-0013-cicd-strategy-and-github-actions.md

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    # Delete previous Claude Code comments to prevent accumulation
    - name: Delete previous Claude comments
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });

          // Find comments from github-actions bot that contain AI review content
          const claudeComments = comments.filter(comment =>
            comment.user.login === 'github-actions[bot]' &&
            (comment.body.includes('ğŸ¤– AI Code Review') ||
             comment.body.includes('ğŸ¤– AI ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼') ||
             comment.body.includes('Claude Code Review') ||
             comment.body.includes('Claude finished')) &&
            !comment.body.includes('[vc]:') // Exclude Vercel comments
          );

          // Delete all previous Claude comments
          console.log(`Found ${claudeComments.length} previous Claude comments to delete`);
          for (const comment of claudeComments) {
            console.log(`Deleting comment ${comment.id} from ${comment.user.login}`);
            await github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: comment.id
            });
          }
          console.log(`Successfully deleted ${claudeComments.length} previous comments`);

    # Extract issue numbers from PR title and description
    - name: Extract issue numbers
      id: extract_issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const prTitle = context.payload.pull_request.title;
          const prBody = context.payload.pull_request.body || '';
          const prText = `${prTitle}\n${prBody}`;

          // Extract issue numbers (#123 format)
          const issueMatches = prText.match(/#\d+/g) || [];
          const issueNumbers = issueMatches.map(match => match.substring(1));

          // Extract commit messages to find issue references there too
          const { data: commits } = await github.rest.pulls.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });

          for (const commit of commits) {
            const commitMatches = commit.commit.message.match(/#\d+/g) || [];
            for (const match of commitMatches) {
              const num = match.substring(1);
              if (!issueNumbers.includes(num)) {
                issueNumbers.push(num);
              }
            }
          }

          console.log('Found issue numbers:', issueNumbers);
          return issueNumbers;

    # Fetch issue content for each referenced issue
    - name: Fetch issue content
      id: fetch_issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issueNumbers = ${{ steps.extract_issues.outputs.result }};
          const issues = [];

          for (const issueNumber of issueNumbers) {
            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });

              // Extract PBI, User Story, and AC from issue body
              const body = issue.body || '';
              issues.push({
                number: issueNumber,
                title: issue.title,
                body: body,
                labels: issue.labels.map(l => l.name)
              });
            } catch (error) {
              console.log(`Could not fetch issue #${issueNumber}:`, error.message);
            }
          }

          return issues;

    # Setup pnpm for Claude Code to access project dependencies
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        run_install: false

    - name: Get pnpm store directory
      id: pnpm-cache
      run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    # Run Claude code review
    - uses: anthropics/claude-code-action@beta
      with:
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        direct_prompt: |
          Please conduct a comprehensive code review of the pull request changes, following the Work Management Service project standards and architecture decisions.

          **CRITICAL: Issue Specification Compliance Check**
          Referenced Issues: ${{ steps.fetch_issues.outputs.result }}

          If there are referenced issues above, you MUST:
          1. Extract the PBI (Product Backlog Item), User Story, and AC (Acceptance Criteria) from each issue
          2. Verify that the implementation strictly adheres to the specifications in the issues
          3. Check that all acceptance criteria are met
          4. Identify any deviations from the specified requirements
          5. Ensure the implementation matches the intent described in the User Story

          Include a dedicated section in your review for "Issue Specification Compliance" where you:
          - List each referenced issue with its PBI and User Story
          - Check each acceptance criterion and mark it as âœ… (met) or âŒ (not met)
          - Explain any gaps or deviations found

          Start by creating a task list of review items you will check, then show progress as you complete each task (e.g., âœ… for completed, ğŸ”„ for in progress).

          First, provide a brief summary of what this PR is trying to achieve based on the changes you see.

          **Project-Specific Coding Standards Check:**

          Frontend (TypeScript/React/Next.js):
          - Verify utilization of TypeScript 5+ + React 19 + Next.js 15 latest features
          - Component placement rules: Single route onlyâ†’app/{route}/_components/, Multiple routes & specific domainâ†’features/{domain}/components/, App-wideâ†’components/
          - Naming conventions: Components use PascalCase, non-components use camelCase, directories use PascalCase for components and kebab-case for others
          - Proper use of Server Components (default) vs Client Components ('use client')
          - Verify React 19 new features usage (useOptimistic, useActionState, use())
          - Confirm shadcn/ui component usage (ui/ directory must not be edited directly)
          - Consistent API communication via TanStack Query
          - Verify Tailwind CSS + CSS variables usage
          - Proper use of cn() utility for conditional classes
          - Format and lint according to Biome configuration
          - Security: Input validation with zod, verify NEXT_PUBLIC_ prefix for environment variables

          **Architecture Decision Records (ADR) Compliance:**
          Please check compliance with the following ADRs:
          - ADR-001: Next.js with Vercel Architecture
          - ADR-002: Server-side Implementation Architecture
          - ADR-003: Database Integration with Vercel Postgres
          - ADR-004: Development Guidelines and Best Practices
          - ADR-005: UI Library and Data Table Selection

          **API Design Standards Verification:**
          - Response format: Successâ†’{success: true, data: {...}}, Errorâ†’{success: false, error: {code, message, details}}
          - Pagination: page/limit parameters, response includes {page, limit, total, totalPages}
          - Date format: ISO 8601 with timezone
          - HTTP status codes: GET/PUT/PATCHâ†’200, POSTâ†’201, DELETEâ†’204, Errorsâ†’400/404/500

          **Quality Check Items:**
          - Test existence and coverage (Frontend: Vitest/Playwright)
          - Performance impact (unnecessary re-renders, N+1 queries)
          - Security vulnerabilities (XSS, SQL injection, CSRF)
          - Proper error handling
          - Documentation updates (JSDoc/TSDoc)

          **Output Format:**
          1. PR Summary - Brief overview of what this PR implements/changes
          2. Overall Code Quality Assessment
          3. Standards Compliance Status
          4. Issues by Severity (Critical/High/Medium/Low)
          5. Specific Improvement Suggestions with Code Examples
          6. Positive Feedback for Well-Written Code

          **IMPORTANT: Include the task list with progress indicators at the beginning of your review to show what you're checking and your progress.**

          Please provide constructive and practical feedback while strictly adhering to the project's standards and architecture decisions.

          **IMPORTANT: Please write all your review comments and feedback in Japanese (æ—¥æœ¬èªã§è¨˜è¼‰ã—ã¦ãã ã•ã„).**

          **CRITICAL: When including code examples, ensure proper markdown formatting:**
          - Use triple backticks with language identifier for code blocks
          - Ensure code blocks are properly closed
          - Avoid nested code blocks in lists
          - If showing code in a list item, indent the code block properly

          **Format your response with the following structure:**

          # ğŸ¤– AI Code Review

          ## ğŸ“‹ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
          (Generate a task list based on what needs to be reviewed for this specific PR. Mark completed items with [x])

          ## ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
          [1-2 line summary of what this PR achieves]

          **ã‚¹ã‚³ã‚¢:** [score]/10

          ## ğŸ” ä¸»è¦ãªç™ºè¦‹äº‹é …
          - Finding 1
          - Finding 2
          - Finding 3

          <details open>
          <summary>ğŸ¯ <b>Issueä»•æ§˜æº–æ‹ ãƒã‚§ãƒƒã‚¯</b></summary>

          [If issues are referenced, provide detailed compliance check here]

          </details>

          <details open>
          <summary>ğŸ“„ <b>è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ</b></summary>

          [Detailed review content organized by sections]

          ### é‡è¦åº¦åˆ¥ã®å•é¡Œç‚¹

          #### ğŸ”´ Critical
          [List critical issues]

          #### ğŸŸ¡ High
          [List high priority issues]

          #### ğŸŸ  Medium
          [List medium priority issues]

          #### ğŸŸ¢ Low
          [List low priority issues]

          </details>

          <details open>
          <summary>ğŸ’¡ <b>æ”¹å–„ææ¡ˆ</b></summary>

          [Specific improvement suggestions]

          **Code examples should use proper markdown syntax:**
          ```language
          // code here
          ```

          </details>
        # Timeout setting (extended for detailed code review)
        timeout_minutes: 20
        # Claude 4 model to use (using Sonnet 4)
        anthropic_model: "claude-sonnet-4-5-20250929"